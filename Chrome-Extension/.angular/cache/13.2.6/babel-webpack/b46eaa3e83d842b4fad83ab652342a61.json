{"ast":null,"code":"import _asyncToGenerator from \"C:\\\\Users\\\\gabri\\\\Documents\\\\GitHub\\\\Base-Camp\\\\Chrome-Extension\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\asyncToGenerator.js\";\nimport { environment } from 'src/environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../connections/connections.service\";\nexport class GlobalVarsService {\n  constructor(connections) {\n    this.connections = connections;\n    this.globalVars = new Map();\n    this.isAccurate = false;\n    this.canConnect = false;\n\n    if (localStorage.getItem(\"globals\") != undefined) {\n      this.globalVars = new Map(JSON.parse(localStorage.getItem(\"globals\"))); // Calculate whether it is wk A or B\n\n      if (JSON.parse(this.getVar(\"doCloudSync\"))) {\n        this.syncFromCloud(false).then(() => {\n          this.setVar(\"lastSignInTime\", JSON.stringify(new Date().getTime()));\n          this.isAccurate = true;\n        });\n      } else {\n        this.isAccurate = true;\n      }\n\n      this.calcCurrentWk();\n    } else {\n      this.isAccurate = true;\n    }\n  }\n\n  calcCurrentWk() {\n    // Switch the current wk from A to B (or vice versa) if it has been a week \n    let lastSignIn = new Date(JSON.parse(this.getVar(\"lastSignInTime\")));\n    let today = new Date();\n    let inBetweenDays = [];\n\n    if (today.getDate() != lastSignIn.getDate() || today.getMonth() != lastSignIn.getMonth()) {\n      // If the app hasn't already been signed into today\n      inBetweenDays = this.getDaysArray(lastSignIn.getTime(), today.getTime());\n    }\n\n    for (var i = 0; i < inBetweenDays.length; i++) {\n      if (inBetweenDays[i].getDay() == 0) {\n        // If there has been a sunday between the last sign in and the current date`\n        // Invert the week letter\n        console.log(\"INVERT\");\n\n        if (this.getVar('weekLetter') == \"a\") {\n          this.setVar(\"weekLetter\", \"b\");\n        } else if (this.getVar('weekLetter') == \"b\") {\n          this.setVar(\"weekLetter\", \"a\");\n        }\n      }\n    } // this.isAccurate = true\n\n  }\n\n  getDaysArray(start, end) {\n    for (var arr = [], dt = new Date(start); dt <= new Date(end); dt.setDate(dt.getDate() + 1)) {\n      arr.push(new Date(dt));\n    }\n\n    return arr;\n  }\n\n  syncFromCloud(forceCloudData) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      return new Promise((resolve, reject) => {\n        console.log(\"SYNCING\");\n        _this.isAccurate = false; // Read current user data from the server\n\n        _this.connections.getUserData(_this.getVar(\"userEmail\"), _this.getVar(\"passwordToken\")).subscribe(res => {\n          let cloudKeys = Object.keys(res[0]);\n          _this.canConnect = true;\n\n          if (res[0][\"lastSignInTime\"] >= Number.parseInt(_this.getVar(\"lastSignInTime\")) || forceCloudData) {\n            // Only set data if the server data is newer or the same age as the local data OR if it needs to be forced (ie on login)\n            for (var i = 0; i < cloudKeys.length; i++) {\n              if (environment.keysToSync.includes(cloudKeys[i])) {\n                if (typeof res[0][cloudKeys[i]] == 'string') {\n                  _this.setVar(cloudKeys[i], res[0][cloudKeys[i]], false);\n                } else {\n                  _this.setVar(cloudKeys[i], JSON.stringify(res[0][cloudKeys[i]]), false);\n                }\n              }\n            }\n          } else {\n            // If the local data is newer then that stored on the cloud,\n            // Upload the changed variables to the cloud\n            console.log(\"LOCAL DATA IS NEWER\");\n\n            for (var i = 0; i < cloudKeys.length; i++) {\n              if (environment.keysToSync.includes(cloudKeys[i])) {\n                if (typeof res[0][cloudKeys[i]] == 'string') {\n                  if (res[0][cloudKeys[i]] != _this.getVar(cloudKeys[i])) {\n                    console.log(\"UPDATING \" + cloudKeys[i]);\n\n                    _this.connections.setUserData(_this.getVar(\"userEmail\"), _this.getVar(\"passwordToken\"), cloudKeys[i], _this.getVar(cloudKeys[i])).subscribe(res => {});\n                  }\n                } else {\n                  // Only use JSON.stringify if the stored value is NOT a string\n                  if (JSON.stringify(res[0][cloudKeys[i]]) != _this.getVar(cloudKeys[i])) {\n                    console.log(\"UPDATING \" + cloudKeys[i]);\n                    console.log(JSON.stringify(_this.getVar(cloudKeys[i])));\n\n                    _this.connections.setUserData(_this.getVar(\"userEmail\"), _this.getVar(\"passwordToken\"), JSON.stringify(cloudKeys[i]), JSON.parse(_this.getVar(cloudKeys[i]))).subscribe(res => {\n                      console.log(\"UPDATED \" + cloudKeys[i]);\n                    });\n                  }\n                }\n              }\n            }\n          }\n\n          resolve();\n        }, err => {\n          _this.canConnect = false;\n          resolve();\n        });\n      });\n    })();\n  }\n\n  saveVars() {\n    localStorage.setItem(\"globals\", JSON.stringify(Array.from(this.globalVars.entries())));\n    console.log(\"SAVING\");\n  }\n\n  wipeStorage() {\n    localStorage.clear();\n    this.globalVars = new Map();\n    this.isAccurate = true;\n  }\n\n  hasAccurateData() {\n    return [this.isAccurate, this.canConnect];\n  }\n\n  getPublicKey() {\n    return new Promise((resolve, reject) => {\n      // Get the current RSA public key from the server\n      this.connections.getPublicKey().then(res => {\n        this.setVar(\"serverPublicKey\", res);\n        setTimeout(() => {\n          resolve();\n        }, 50);\n      });\n    });\n  }\n\n  setVar(key, val, doCloudSync) {\n    this.globalVars.set(key, val);\n    setTimeout(() => {\n      this.saveVars();\n    }, 50);\n\n    if (environment.keysToSync.includes(key) && doCloudSync != false && this.getVar(\"doCloudSync\") == \"true\" && this.canConnect) {\n      var valToUpload = val;\n\n      try {\n        valToUpload = JSON.parse(valToUpload);\n      } catch (SyntaxError) {}\n\n      let intVal = parseInt(valToUpload);\n\n      if (!Number.isNaN(intVal)) {\n        valToUpload = intVal;\n      }\n\n      this.connections.setUserData(this.getVar(\"userEmail\"), this.getVar(\"passwordToken\"), key, valToUpload).subscribe(res => {\n        console.log(key + \" Updated on the cloud\");\n      });\n    }\n  }\n\n  getVar(key) {\n    if (this.globalVars.get(key)) {\n      return this.globalVars.get(key);\n    } else {\n      return \"empty\";\n    }\n  }\n\n}\n\nGlobalVarsService.ɵfac = function GlobalVarsService_Factory(t) {\n  return new (t || GlobalVarsService)(i0.ɵɵinject(i1.ConnectionsService));\n};\n\nGlobalVarsService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: GlobalVarsService,\n  factory: GlobalVarsService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["C:/Users/gabri/Documents/GitHub/Base-Camp/Chrome-Extension/src/app/services/globals/global-vars.service.ts"],"names":["environment","i0","i1","GlobalVarsService","constructor","connections","globalVars","Map","isAccurate","canConnect","localStorage","getItem","undefined","JSON","parse","getVar","syncFromCloud","then","setVar","stringify","Date","getTime","calcCurrentWk","lastSignIn","today","inBetweenDays","getDate","getMonth","getDaysArray","i","length","getDay","console","log","start","end","arr","dt","setDate","push","forceCloudData","Promise","resolve","reject","getUserData","subscribe","res","cloudKeys","Object","keys","Number","parseInt","keysToSync","includes","setUserData","err","saveVars","setItem","Array","from","entries","wipeStorage","clear","hasAccurateData","getPublicKey","setTimeout","key","val","doCloudSync","set","valToUpload","SyntaxError","intVal","isNaN","get","ɵfac","GlobalVarsService_Factory","t","ɵɵinject","ConnectionsService","ɵprov","ɵɵdefineInjectable","token","factory","providedIn"],"mappings":"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","sourcesContent":["import { environment } from 'src/environments/environment';\r\nimport * as i0 from \"@angular/core\";\r\nimport * as i1 from \"../connections/connections.service\";\r\nexport class GlobalVarsService {\r\n    constructor(connections) {\r\n        this.connections = connections;\r\n        this.globalVars = new Map();\r\n        this.isAccurate = false;\r\n        this.canConnect = false;\r\n        if (localStorage.getItem(\"globals\") != undefined) {\r\n            this.globalVars = new Map(JSON.parse(localStorage.getItem(\"globals\")));\r\n            // Calculate whether it is wk A or B\r\n            if (JSON.parse(this.getVar(\"doCloudSync\"))) {\r\n                this.syncFromCloud(false).then(() => {\r\n                    this.setVar(\"lastSignInTime\", JSON.stringify(new Date().getTime()));\r\n                    this.isAccurate = true;\r\n                });\r\n            }\r\n            else {\r\n                this.isAccurate = true;\r\n            }\r\n            this.calcCurrentWk();\r\n        }\r\n        else {\r\n            this.isAccurate = true;\r\n        }\r\n    }\r\n    calcCurrentWk() {\r\n        // Switch the current wk from A to B (or vice versa) if it has been a week \r\n        let lastSignIn = new Date(JSON.parse(this.getVar(\"lastSignInTime\")));\r\n        let today = new Date();\r\n        let inBetweenDays = [];\r\n        if (today.getDate() != lastSignIn.getDate() || today.getMonth() != lastSignIn.getMonth()) { // If the app hasn't already been signed into today\r\n            inBetweenDays = this.getDaysArray(lastSignIn.getTime(), today.getTime());\r\n        }\r\n        for (var i = 0; i < inBetweenDays.length; i++) {\r\n            if (inBetweenDays[i].getDay() == 0) { // If there has been a sunday between the last sign in and the current date`\r\n                // Invert the week letter\r\n                console.log(\"INVERT\");\r\n                if (this.getVar('weekLetter') == \"a\") {\r\n                    this.setVar(\"weekLetter\", \"b\");\r\n                }\r\n                else if (this.getVar('weekLetter') == \"b\") {\r\n                    this.setVar(\"weekLetter\", \"a\");\r\n                }\r\n            }\r\n        }\r\n        // this.isAccurate = true\r\n    }\r\n    getDaysArray(start, end) {\r\n        for (var arr = [], dt = new Date(start); dt <= new Date(end); dt.setDate(dt.getDate() + 1)) {\r\n            arr.push(new Date(dt));\r\n        }\r\n        return arr;\r\n    }\r\n    ;\r\n    async syncFromCloud(forceCloudData) {\r\n        return new Promise((resolve, reject) => {\r\n            console.log(\"SYNCING\");\r\n            this.isAccurate = false;\r\n            // Read current user data from the server\r\n            this.connections.getUserData(this.getVar(\"userEmail\"), this.getVar(\"passwordToken\")).subscribe((res) => {\r\n                let cloudKeys = Object.keys(res[0]);\r\n                this.canConnect = true;\r\n                if (res[0][\"lastSignInTime\"] >= Number.parseInt(this.getVar(\"lastSignInTime\")) || forceCloudData) {\r\n                    // Only set data if the server data is newer or the same age as the local data OR if it needs to be forced (ie on login)\r\n                    for (var i = 0; i < cloudKeys.length; i++) {\r\n                        if (environment.keysToSync.includes(cloudKeys[i])) {\r\n                            if (typeof res[0][cloudKeys[i]] == 'string') {\r\n                                this.setVar(cloudKeys[i], res[0][cloudKeys[i]], false);\r\n                            }\r\n                            else {\r\n                                this.setVar(cloudKeys[i], JSON.stringify(res[0][cloudKeys[i]]), false);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    // If the local data is newer then that stored on the cloud,\r\n                    // Upload the changed variables to the cloud\r\n                    console.log(\"LOCAL DATA IS NEWER\");\r\n                    for (var i = 0; i < cloudKeys.length; i++) {\r\n                        if (environment.keysToSync.includes(cloudKeys[i])) {\r\n                            if (typeof res[0][cloudKeys[i]] == 'string') {\r\n                                if (res[0][cloudKeys[i]] != this.getVar(cloudKeys[i])) {\r\n                                    console.log(\"UPDATING \" + cloudKeys[i]);\r\n                                    this.connections.setUserData(this.getVar(\"userEmail\"), this.getVar(\"passwordToken\"), cloudKeys[i], this.getVar(cloudKeys[i])).subscribe((res) => { });\r\n                                }\r\n                            }\r\n                            else { // Only use JSON.stringify if the stored value is NOT a string\r\n                                if (JSON.stringify(res[0][cloudKeys[i]]) != this.getVar(cloudKeys[i])) {\r\n                                    console.log(\"UPDATING \" + cloudKeys[i]);\r\n                                    console.log(JSON.stringify(this.getVar(cloudKeys[i])));\r\n                                    this.connections.setUserData(this.getVar(\"userEmail\"), this.getVar(\"passwordToken\"), JSON.stringify(cloudKeys[i]), JSON.parse(this.getVar(cloudKeys[i]))).subscribe((res) => {\r\n                                        console.log(\"UPDATED \" + cloudKeys[i]);\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                resolve();\r\n            }, err => {\r\n                this.canConnect = false;\r\n                resolve();\r\n            });\r\n        });\r\n    }\r\n    saveVars() {\r\n        localStorage.setItem(\"globals\", JSON.stringify(Array.from(this.globalVars.entries())));\r\n        console.log(\"SAVING\");\r\n    }\r\n    wipeStorage() {\r\n        localStorage.clear();\r\n        this.globalVars = new Map();\r\n        this.isAccurate = true;\r\n    }\r\n    hasAccurateData() {\r\n        return [this.isAccurate, this.canConnect];\r\n    }\r\n    getPublicKey() {\r\n        return new Promise((resolve, reject) => {\r\n            // Get the current RSA public key from the server\r\n            this.connections.getPublicKey().then((res) => {\r\n                this.setVar(\"serverPublicKey\", res);\r\n                setTimeout(() => {\r\n                    resolve();\r\n                }, 50);\r\n            });\r\n        });\r\n    }\r\n    setVar(key, val, doCloudSync) {\r\n        this.globalVars.set(key, val);\r\n        setTimeout(() => {\r\n            this.saveVars();\r\n        }, 50);\r\n        if (environment.keysToSync.includes(key) && doCloudSync != false && this.getVar(\"doCloudSync\") == \"true\" && this.canConnect) {\r\n            var valToUpload = val;\r\n            try {\r\n                valToUpload = JSON.parse(valToUpload);\r\n            }\r\n            catch (SyntaxError) {\r\n            }\r\n            let intVal = parseInt(valToUpload);\r\n            if (!Number.isNaN(intVal)) {\r\n                valToUpload = intVal;\r\n            }\r\n            this.connections.setUserData(this.getVar(\"userEmail\"), this.getVar(\"passwordToken\"), key, valToUpload).subscribe((res) => {\r\n                console.log(key + \" Updated on the cloud\");\r\n            });\r\n        }\r\n    }\r\n    getVar(key) {\r\n        if (this.globalVars.get(key)) {\r\n            return this.globalVars.get(key);\r\n        }\r\n        else {\r\n            return \"empty\";\r\n        }\r\n    }\r\n}\r\nGlobalVarsService.ɵfac = function GlobalVarsService_Factory(t) { return new (t || GlobalVarsService)(i0.ɵɵinject(i1.ConnectionsService)); };\r\nGlobalVarsService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: GlobalVarsService, factory: GlobalVarsService.ɵfac, providedIn: 'root' });\r\n"]},"metadata":{},"sourceType":"module"}